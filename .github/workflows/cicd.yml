name: Build and push docker image to ECR

on:
  push:

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Configure AWS credentials
          run: |
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region ${{ secrets.AWS_REGION }}

        - name: Login to Amazon ECR
          run: |
           aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 681414095026.dkr.ecr.us-east-1.amazonaws.com
        
        - name: Build and push Docker image to ECR
          run: |
            docker build -t mediplus:V${{ github.run_number }} .
            docker tag mediplus:V${{ github.run_number }} 681414095026.dkr.ecr.us-east-1.amazonaws.com/mediplus:V${{ github.run_number }}
            docker push 681414095026.dkr.ecr.us-east-1.amazonaws.com/mediplus:V${{ github.run_number }}
        

  deploy:
    runs-on: ubuntu-latest
    needs: build-push
    steps: 
      - name: check my ssh key
        run: |
          echo "${{ secrets.SSH_KEY }}" > mykey.pem
          chmod 600 mykey.pem
          cat mykey.pem

          ssh -o StrictHostKeyChecking=no -i mykey.pem ubuntu@100.30.99.90 "docker pull 681414095026.dkr.ecr.us-east-1.amazonaws.com/mediplus:V${{ github.run_number }}"

                    ssh -o StrictHostKeyChecking=no -i mykey.pem ubuntu@100.30.99.90 "docker rm -f mediplus"

          ssh -o StrictHostKeyChecking=no -i mykey.pem ubuntu@100.30.99.90 "docker run -d --name mediplus -p 80:80 681414095026.dkr.ecr.us-east-1.amazonaws.com/mediplus:V${{ github.run_number }}"

























  #     #   uses: docker/login-action@v3
  #     #   with:
  #     #     username: ${{ secrets.DOCKERHUB_USERNAME }}
  #     #     password: ${{ secrets.DOCKERHUB_TOKEN }}
  #     # -
  #     #   name: Set up QEMU
  #     #   uses: docker/setup-qemu-action@v3
  #     # -
  #     #   name: Set up Docker Buildx
  #     #   uses: docker/setup-buildx-action@v3
  #     # -
  #     #   name: Build and push
  #     #   uses: docker/build-push-action@v6
  #     #   with:
  #     #     push: true
  #     #     tags: smartagbawo/mediplus:v3
